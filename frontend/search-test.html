<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Suggestions Test</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
        .search-bar-container { position: relative; display: inline-block; }
        .search-suggestions-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #007bff;
            border-radius: 8px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 2px;
        }
        .search-suggestion-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f5f5f5;
        }
        .search-suggestion-item:hover { background-color: #f8f9fa; }
        .search-suggestion-item:last-child { border-bottom: none; }
        .suggestion-text { flex: 1; font-weight: 500; color: #2c3e50; }
        .debug-output {
            margin-top: 20px;
            padding: 10px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container" style="padding: 20px;">
        <h1>üîç Search Suggestions Test</h1>

        <div class="panel panel-primary">
            <div class="panel-heading">
                <h3 class="panel-title">Test Search Suggestions</h3>
            </div>
            <div class="panel-body">
                <div class="search-bar-container">
                    <form class="search-bar" style="display: flex; border: 1px solid #ccc; border-radius: 4px;" onsubmit="return false;">
                        <input type="text"
                               id="testSearchInput"
                               style="border: none; padding: 8px 12px; flex: 1; outline: none;"
                               placeholder="Type 3+ characters..."
                               oninput="onSearchInput(this.value)"
                               autocomplete="off">
                        <button type="button" class="btn btn-default" style="border: none; border-radius: 0 4px 4px 0;">
                            <i class="fa fa-search"></i>
                        </button>
                    </form>

                    <div id="testSuggestionsDropdown" class="search-suggestions-dropdown" style="display: none;">
                        <div id="suggestionsContent"></div>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <button class="btn btn-success" onclick="testAPI()">Test API</button>
                    <button class="btn btn-info" onclick="checkDB()">Check Database</button>
                    <button class="btn btn-warning" onclick="addVideos()">Add Test Videos</button>
                    <button class="btn btn-danger" onclick="clearDebug()">Clear Debug</button>
                    <button class="btn btn-primary" onclick="testSuggestionsDirect()">Test Suggestions Direct</button>
                </div>

                <div id="debugOutput" class="debug-output"></div>
            </div>
        </div>
    </div>

    <script>
        function log(message) {
            const debug = document.getElementById('debugOutput');
            debug.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
            debug.scrollTop = debug.scrollHeight;
            console.log(message);
        }

        function clearDebug() {
            document.getElementById('debugOutput').textContent = '';
        }

        let suggestionTimeout;

        function onSearchInput(value) {
            log('Input changed: "' + value + '" (length: ' + value.length + ')');

            clearTimeout(suggestionTimeout);

            if (value.length < 3) {
                hideSuggestions();
                return;
            }

            log('Query long enough, fetching suggestions...');
            suggestionTimeout = setTimeout(() => {
                fetchSuggestions(value);
            }, 300);
        }

        function fetchSuggestions(query) {
            log('Fetching suggestions for: ' + query);

            fetch('/LCMTVWebNew/backend/api/search/suggestions?q=' + encodeURIComponent(query))
                .then(response => {
                    log('API Response status: ' + response.status);
                    if (!response.ok) {
                        throw new Error('HTTP ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    log('API Response: ' + JSON.stringify(data, null, 2));
                    if (data.success && data.data && data.data.suggestions) {
                        showSuggestions(data.data.suggestions);
                    } else {
                        log('No suggestions in response');
                        hideSuggestions();
                    }
                })
                .catch(error => {
                    log('Error fetching suggestions: ' + error.message);
                    hideSuggestions();
                });
        }

        function showSuggestions(suggestions) {
            log('Showing ' + suggestions.length + ' suggestions');

            const dropdown = document.getElementById('testSuggestionsDropdown');
            const content = document.getElementById('suggestionsContent');

            if (suggestions.length === 0) {
                content.innerHTML = '<div style="padding: 10px; color: #666;">No suggestions found</div>';
            } else {
                content.innerHTML = suggestions.map((suggestion, index) => `
                    <div class="search-suggestion-item" onclick="selectSuggestion('${suggestion.suggestion || suggestion}')">
                        <i class="fa fa-search" style="color: #6c757d; margin-right: 10px; width: 14px;"></i>
                        <span class="suggestion-text">${suggestion.suggestion || suggestion}</span>
                        ${suggestion.video_id ? `<small style="color: #666;">‚Üí Video #${suggestion.video_id}</small>` : ''}
                        ${suggestion.type ? `<span class="badge" style="background: #e9ecef; color: #495057;">${suggestion.type}</span>` : ''}
                    </div>
                `).join('');
            }

            dropdown.style.display = 'block';
        }

        function hideSuggestions() {
            document.getElementById('testSuggestionsDropdown').style.display = 'none';
        }

        function selectSuggestion(suggestion) {
            log('Selected suggestion: ' + JSON.stringify(suggestion));
            if (suggestion.video_id) {
                log('Navigating to video: ' + suggestion.video_id);
                alert('Would navigate to video page: /video/' + suggestion.video_id);
            } else {
                document.getElementById('testSearchInput').value = suggestion.suggestion || suggestion;
            }
            hideSuggestions();
        }

        function testAPI() {
            const query = prompt('Enter test query (3+ chars):', 'rick');
            if (query && query.length >= 3) {
                fetchSuggestions(query);
            }
        }

        function checkDB() {
            log('Checking database...');
            fetch('/LCMTVWebNew/backend/api/debug/database')
                .then(response => response.json())
                .then(data => {
                    log('Database check: ' + JSON.stringify(data, null, 2));
                    alert('Videos in DB: ' + (data.data ? data.data.videos_count : 'unknown'));
                })
                .catch(error => {
                    log('Database check failed: ' + error.message);
                });
        }

        function addVideos() {
            log('Adding test videos...');
            fetch('/LCMTVWebNew/backend/api/debug/add-test-videos', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    log('Add videos result: ' + JSON.stringify(data, null, 2));
                    alert(data.data ? data.data.message : 'Videos added');
                })
                .catch(error => {
                    log('Add videos failed: ' + error.message);
                });
        }

        function testSuggestionsDirect() {
            var query = prompt('Enter query:', 'rick');
            if (!query || query.length < 3) return;

            log('Testing suggestions directly for: ' + query);
            fetch('/LCMTVWebNew/backend/api/search/suggestions?q=' + encodeURIComponent(query))
                .then(response => {
                    log('Response status: ' + response.status);
                    return response.text();
                })
                .then(text => {
                    log('Raw response: ' + text);
                    try {
                        var data = JSON.parse(text);
                        log('Parsed response: ' + JSON.stringify(data, null, 2));

                        if (data.success && data.data && data.data.suggestions) {
                            log('Found ' + data.data.suggestions.length + ' suggestions');
                            showSuggestions(data.data.suggestions);
                        } else {
                            log('No suggestions found in response');
                        }
                    } catch (e) {
                        log('JSON parse error: ' + e.message);
                    }
                })
                .catch(error => {
                    log('Request failed: ' + error.message);
                });
        }

        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-bar-container')) {
                hideSuggestions();
            }
        });

        log('Search Suggestions Test loaded');
        log('Type 3+ characters in the search box above to test suggestions');
    </script>
</body>
</html>